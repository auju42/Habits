const fs = require('fs');
const path = require('path');

const ROOT_DIR = path.resolve(__dirname, '..');
const OUTPUT_FILE = path.join(ROOT_DIR, 'PROJECT_STRUCTURE.md');
const IGNORE_DIRS = ['.git', 'node_modules', 'dist', '.gemini', 'scripts'];
const IGNORE_FILES = ['.DS_Store', 'package-lock.json', '.env.local'];

function generateTree(dir, prefix = '') {
    let results = '';
    const files = fs.readdirSync(dir)
        .filter(file => !IGNORE_DIRS.includes(file) && !IGNORE_FILES.includes(file))
        .sort((a, b) => {
            const aStat = fs.statSync(path.join(dir, a));
            const bStat = fs.statSync(path.join(dir, b));
            if (aStat.isDirectory() && !bStat.isDirectory()) return -1;
            if (!aStat.isDirectory() && bStat.isDirectory()) return 1;
            return a.localeCompare(b);
        });

    files.forEach((file, index) => {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);
        const isLast = index === files.length - 1;
        const pointer = isLast ? '└── ' : '├── ';

        results += `${prefix}${pointer}${file}${stat.isDirectory() ? '/' : ''}\n`;

        if (stat.isDirectory()) {
            const newPrefix = prefix + (isLast ? '    ' : '│   ');
            results += generateTree(filePath, newPrefix);
        }
    });

    return results;
}

const directoryDescriptions = {
    'src/': 'Main source code directory',
    'src/components/': 'Reusable UI components',
    'src/contexts/': 'React Context providers (Auth, Theme, etc.)',
    'src/lib/': 'Third-party library initializations (Firebase, etc.)',
    'src/pages/': 'Top-level page components/routes',
    'src/services/': 'API and backend service logic',
    'src/types/': 'TypeScript interfaces and type definitions',
    'src/utils/': 'Helper functions and utilities',
    'public/': 'Static assets (images, icons, etc.)',
};

let content = `# Project Structure Overview

This file is automatically generated. Do not edit it manually.

## Directory Tree

\`\`\`text
Habits/
${generateTree(ROOT_DIR)}
\`\`\`

## Key Directories

| Directory | Description |
| :--- | :--- |
${Object.entries(directoryDescriptions).map(([dir, desc]) => `| \`${dir}\` | ${desc} |`).join('\n')}

---
*Last updated: ${new Date().toLocaleString()}*
`;

fs.writeFileSync(OUTPUT_FILE, content);
console.log('PROJECT_STRUCTURE.md has been updated!');
